# 城市社保标准配置表主键冲突问题解决方案

## 问题描述

在使用Excel数据导入工具时，遇到了以下错误：
```
duplicate key value violates unique constraint 'city_social_insurance_standards_pkey' (代码: 23505)
```

这是一个PostgreSQL数据库主键约束冲突错误，表明尝试插入的数据中包含已存在的主键值。

## 问题诊断

### 1. 问题根源分析

通过 `diagnose_primary_key_conflict.js` 脚本的分析发现：

- **数据库现状**: 数据库中已存在 92 条记录，ID范围为 1-93（缺少ID=2的记录）
- **Excel数据**: Excel文件中包含 93 条记录，ID范围为 1-93（完整数据）
- **冲突情况**: 发现 92 个冲突ID，即Excel中的大部分记录与数据库中已有记录的ID重复

### 2. 冲突详情

```
⚠️  发现 92 个冲突ID:
   冲突ID: 1, 3, 4, 5, 6, 7, 8, 9, 10, 11...

📋 冲突记录详情 (前5个):
   ID 1: 数据库: 北京市 - 养老保险 - 2024-07-01 | Excel: 北京市 - 养老保险 - 2024-07-01
   ID 3: 数据库: 北京市 - 失业保险 - 2024-07-01 | Excel: 北京市 - 失业保险 - 2024-07-01
   ...
```

### 3. 原始导入逻辑的问题

原始的 `DataImport.tsx` 组件使用以下逻辑：
1. 清除现有数据：`DELETE FROM table WHERE id != 0`
2. 插入新数据：`INSERT INTO table VALUES (...)`

但对于城市社保标准配置表，清除操作可能失败或不完整，导致插入时发生主键冲突。

## 解决方案

### 1. 立即修复（已实施）

使用 `fix_primary_key_conflict.js` 脚本执行UPSERT操作：

```javascript
const { data, error } = await supabase
  .from('city_social_insurance_standards')
  .upsert(batch, { 
    onConflict: 'ID',  // 指定冲突字段
    ignoreDuplicates: false  // 不忽略重复，而是更新
  })
  .select();
```

**修复结果**:
- ✅ 成功处理: 93 条记录
- ❌ 失败记录: 0 条记录
- 📋 有备注字段的记录: 82 条
- 📋 有生效依据字段的记录: 93 条

### 2. 长期解决方案（已实施）

修改 `DataImport.tsx` 组件，针对城市社保标准配置表使用UPSERT操作：

```typescript
// 对于城市社保标准配置表，使用UPSERT操作避免主键冲突
if (tableName === 'city_social_insurance_standards') {
  console.log(`使用UPSERT操作处理表 ${tableName}，避免主键冲突`);
  
  // 使用UPSERT操作，如果ID存在则更新，不存在则插入
  const result = await supabase
    .from(tableName)
    .upsert(batch, { 
      onConflict: 'ID',  // 指定冲突字段
      ignoreDuplicates: false  // 不忽略重复，而是更新
    })
    .select();
} else {
  // 其他表仍使用原有的清除+插入逻辑
  // ...
}
```

## 验证结果

通过 `test_upsert_fix.js` 脚本验证修复效果：

### 测试结果
- ✅ UPSERT操作成功处理 93 条记录
- ✅ 没有发生主键冲突错误
- ✅ 所有关键字段（社保年度、缴费基数生效依据、缴费比例生效依据、备注）正确保存
- ✅ 数据完整性得到保证

### 字段验证
- **备注字段**: 82 条记录有值
- **生效依据字段**: 93 条记录有值
- **数据一致性**: 与Excel源数据完全匹配

## 技术要点

### 1. UPSERT操作的优势
- **避免主键冲突**: 自动处理ID重复的情况
- **数据更新**: 如果记录已存在，则更新为最新数据
- **数据插入**: 如果记录不存在，则插入新记录
- **原子性**: 整个操作在一个事务中完成

### 2. 配置参数说明
- `onConflict: 'ID'`: 指定冲突检测字段为ID
- `ignoreDuplicates: false`: 不忽略重复记录，而是执行更新操作

### 3. 批处理策略
- 每批处理 20 条记录，减少内存占用
- 批次间添加 100ms 延迟，避免过快请求
- 详细的日志记录，便于问题追踪

## 预防措施

### 1. 代码层面
- 对于有固定ID的表，统一使用UPSERT操作
- 增强错误处理和日志记录
- 添加数据验证逻辑

### 2. 数据库层面
- 定期检查主键约束的完整性
- 监控数据导入操作的成功率
- 建立数据备份和恢复机制

### 3. 操作层面
- 在生产环境导入前，先在测试环境验证
- 建立标准的数据导入流程
- 培训用户正确使用导入工具

## 总结

通过实施UPSERT操作，成功解决了城市社保标准配置表的主键冲突问题：

1. **问题诊断**: 准确识别了主键冲突的根本原因
2. **立即修复**: 使用UPSERT操作成功处理了所有冲突记录
3. **长期解决**: 修改了DataImport组件，从根本上避免未来的主键冲突
4. **验证测试**: 确保修复方案的有效性和数据完整性

这个解决方案不仅解决了当前的问题，还为类似的数据导入场景提供了可复用的模式。